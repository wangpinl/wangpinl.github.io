<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  
  <title itemprop="name">Redis初识 | 微笑的个人主页</title>
  
    <link rel="shortcut icon" href="/images/favicon.ico">
  
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+SerifMerriweather|Merriweather+Sans|Source+Code+Pro|Ubuntu:400,700|Noto+Serif+SC" media="all">
  <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
  <link rel="stylesheet" id="saukra_css-css" href="/css/style.css" type="text/css" media="all">
  <link rel="stylesheet" href="/css/lib.min.css" media="all">
  <link rel="stylesheet" href="/css/font.css" media="all">
  <link rel="stylesheet" href="/css/insight.css" media="all">
  <link rel="stylesheet" href="/css/jquery.fancybox.min.css" media="all">
  <link rel="stylesheet" href="/css/zoom.css" media="all">
  <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<!--   <link rel="stylesheet" id="saukra_css-css" href="https://2heng.xin/wp-content/cache/autoptimize/css/autoptimize_ad42a61f4c7d4bdd9f91afcff6b5dda5.css
" type="text/css" media="all"> -->
  <script>
  /*Initial Variables*/
  var mashiro_option = new Object();
  var mashiro_global = new Object();
  mashiro_option.NProgressON = true;
  /* 
   * 邮箱信息之类的东西可以填在这里，这些js变量基本都作用于sakura-app.js
   * 这样的设置仅是为了方便在基于PHP开发的主题中设置js变量，既然移植到了Node上，我想或许可以精简这一逻辑吧
   */
  mashiro_option.email_domain = "";
  mashiro_option.email_name = "";
  mashiro_option.cookie_version_control = "";
  mashiro_option.qzone_autocomplete = false;
  mashiro_option.site_name = "微笑の个人主页";
  mashiro_option.author_name = "个人主页";
  mashiro_option.site_url = "https://secondes.github.io/";
  mashiro_option.v_appId = "QXrHWOweL6iiH8ULUmPjBVhb-gzGzoHsz";
  mashiro_option.v_appKey = "3es5KSduLLezurh1rn90e0vu";
  mashiro_option.mathjax = "0";
  mashiro_option.qq_api_url = "https://api.mashiro.top/qqinfo/"; 
  mashiro_option.qq_avatar_api_url = "https://api.mashiro.top/qqinfo/";

  // mashiro_option.jsdelivr_css_src = "https://cdn.jsdelivr.net/gh/moezx/cdn@3.4.5/css/lib.min.css";
  // mashiro_option.float_player_on = true;

  /*End of Initial Variables*/
  </script>
  <script type="text/javascript">
  var bg = "https://www.yremp.live/images/2020/04/22/79344899_p091551.jpg".split(",");
  var bgindex = Math.floor(Math.random()*bg.length);
  if (!!window.ActiveXObject || "ActiveXObject" in window) { //is IE?
    alert('朋友，IE浏览器未适配哦~');
  }
  </script>
  <style type="text/css">
  .hljs-ln{border-collapse:collapse}.hljs-ln td{padding:0}.hljs-ln-n:before{content:attr(data-line-number)}
  </style>
  <style type="text/css">.site-top .lower nav{display:block !important;},.post-like a,.post-share .show-share,.sub-text,.we-info a,span.sitename,.post-more i:hover,#pagination a:hover,.post-content a:hover,.float-content i:hover{color:#FE9600}.feature i,.download,.navigator i:hover,.links ul li:before,.ar-time i,span.ar-circle,.object,.comment .comment-reply-link,.siren-checkbox-radio:checked + .siren-checkbox-radioInput:after{background:#FE9600}::-webkit-scrollbar-thumb{background:#FE9600}.download,.navigator i:hover,.link-title,.links ul li:hover,#pagination a:hover,.comment-respond input[type='submit']:hover{border-color:#FE9600}.entry-content a:hover,.site-info a:hover,.comment h4 a,#comments-navi a.prev,#comments-navi a.next,.comment h4 a:hover,.site-top ul li a:hover,.entry-title a:hover,#archives-temp h3,span.page-numbers.current,.sorry li a:hover,.site-title a:hover,i.iconfont.js-toggle-search.iconsearch:hover,.comment-respond input[type='submit']:hover{color:#FE9600}.comments .comments-main{display:block !important;}.comments .comments-hidden{display:none !important;}background-position:center center;background-attachment:inherit;}
  </style>
</head>
</html>
<body class="page-template page-template-user page-template-page-analytics page-template-userpage-analytics-php page page-id-1297 chinese-font serif isWebKit" style="background-image: url(https://www.yremp.live/images/2020/03/18/77865316_p07c784.jpg);">
  <div class="scrollbar" id="bar">
  </div>
  <a href="#" class="cd-top faa-float animated"></a>
  <section id="main-container">
    <div class="headertop ">
  <div id="banner_wave_1"></div>
  <div id="banner_wave_2"></div>
  <figure id="centerbg" class="centerbg">
    <div class="focusinfo no-select">
      <div class="header-tou">
        <img src="https://q2.qlogo.cn/headimg_dl?dst_uin=46029882&spec=640">
      </div>
      <div class="header-info">
        <p>The degree of loving is measured by the degree of giving</p>
        <div class="top-social_v2">
          <li id="bg-pre">
            <img class="flipx" src="https://cdn.jsdelivr.net/gh/secondes/cdn/img/other/next-b.svg">
          </li>
          
            
              
                <li>
                  <a href="http://github.com/Secondes" target="_blank" class="social-github" title="github">
                    <img src="https://www.yremp.live/images/2019/09/03/github2cfca.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://twitter.com/1t5RE1tdGpmcW4Z" target="_blank" class="social-github" title="twitter">
                    <img src="https://www.yremp.live/images/2019/09/03/twitter68cc0.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="https://www.facebook.com/profile.php?id=100035330672131" target="_blank" class="social-github" title="facebook">
                    <img src="https://www.yremp.live/images/2019/09/03/facebook73baf.png">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="http://moxiaowu495@gmail.com" target="_blank" class="social-github" title="gmail">
                    <img src="https://cdn.jsdelivr.net/gh/secondes/cdn/img/social/email.svg">
                  </a>
                </li>
              
            
              
                <li>
                  <a href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=46029882&amp;website=www.oicqzone.com" target="_blank" class="social-github" title="qq">
                    <img src="https://www.yremp.live/images/2019/09/03/qqdfdb4.png">
                  </a>
                </li>
              
            
              
                <li class="wechat">
                  <a href="/#">
                    <img src="https://www.yremp.live/images/2019/09/03/wechat28a70.png">
                  </a>
                  <div class="wechatInner">
                    <img src="https://cdn.jsdelivr.net/gh/secondes/cdn/img/custom/wechat.jpg">
                  </div>
                </li>
              
            
          
          <li id="bg-next">
            <img src="https://cdn.jsdelivr.net/gh/secondes/cdn/img/other/next-b.svg">
          </li>
        </div>
      </div>
    </div>
  </figure>
  <div id="video-container" style="display:none">
    <video style="object-fit: fill" id="bgvideo" class="video" video-name src width="auto" preload="auto">
    </video>
    <div id="video-btn" class="loadvideo videolive">
    </div>
    <div id="video-add">
    </div>
    <div class="video-stu">
    </div>
  </div>
  <div class="headertop-down faa-float animated" onclick="headertop_down()">
    <span>
      <i class="fa fa-chevron-down" aria-hidden="true">
      </i>
    </span>
  </div>
</div>
    <div id="page" class="site wrapper">
      <header class="site-header no-select gizle sabit" role="banner">
  <div class="site-top">
    <div class="site-branding">
      <span class="site-title">
        <span class="logolink moe-mashiro">
          <a href="/">
            <span class="sakurasono">微笑の</span>
            <span class="shironeko">个人主页</span>
          </a>
        </span>
      </span>
    </div>
    <div class="searchbox search-form-submit">
      <i class="iconfont js-toggle-search iconsearch icon-search">
      </i>
    </div>
    <div id="show-nav" class="showNav mobile-fit">
      <div class="line line1">
      </div>
      <div class="line line2">
      </div>
      <div class="line line3">
      </div>
    </div>
    <div class="lower-cantiner">
      <div class="lower">
        <nav class="mobile-fit-control hide">
          <ul id="menu-new" class="menu">
            
              <li>
                <a href="/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
                    首页
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/archives">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
                    归档
                  </span>
                </a>
                
                  <ul class="sub-menu">
                    
                      <li>
                        <a href="/categories/技术/">
                          <i class="fa fa-code" aria-hidden="true"></i>
                          技术
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/生活/">
                          <i class="fa fa-file-text-o" aria-hidden="true"></i>
                          生活
                        </a>
                      </li>
                    
                      <li>
                        <a href="/categories/资源/">
                          <i class="fa fa-cloud-download" aria-hidden="true"></i>
                          资源
                        </a>
                      </li>
                    
                  </ul>
                
              </li>
            
              <li>
                <a href="/comment/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
                    留言板
                  </span>
                </a>
                
              </li>
            
              <li>
                <a href="/links/">
                  <span class="faa-parent animated-hover">
                    <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
                    友人帐
                  </span>
                </a>
                
              </li>
            
          </ul>
        </nav>
      </div>
    </div>
  </div>
</header>

      <link rel="stylesheet" type="text/css" href="/css/sharejs.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">
<div class="pattern-center-blank"></div>

  <div class="pattern-center single-center">
    <!-- 有配图默认渲染第一张 -->
    <div class="pattern-attachment-img lazyload" style="background-image: url(https://www.yremp.live/images/2019/09/03/QQ201909031537356c6e2.gif);" src="https://cdn.jsdelivr.net/gh/Secondes/cdn/img/loader/orange.progress-bar-stripe-loader.svg" data-src="https://www.yremp.live/images/2019/09/03/QQ201909031537356c6e2.gif">
    </div>
    <header class="pattern-header single-header">
      <h1 class="entry-title">
      Redis初识</h1>
      <p class="entry-census">
        <span>
          <a href="www.secondaries.cn">
            <img src="https://q2.qlogo.cn/headimg_dl?dst_uin=46029882&spec=100">
          </a>
        </span>
        <span>
          <a href="www.secondaries.cn">微笑</a>
        </span>
        <span class="bull">
        ·</span>
        2019-9-3<span class="bull">
        ·</span>
      <span id="busuanzi_value_page_pv"></span>次阅读</p>
    </header>
  </div>

<div id="content" class="site-content">
  <div id="primary" class="content-area">
    <main id="main" class="site-main" role="main">
      <article id="post-1" class="post-1 post type-post status-publish format-standard has-post-thumbnail hentry category-uncategorized">
        <div class="toc"></div>
        <!--<div class="toc-entry-content"><!-- 套嵌目录使用（主要为了支援评论）-->
        
        <div class="entry-content">
          <h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><h2 id="课前基础知识"><a href="#课前基础知识" class="headerlink" title="课前基础知识"></a>课前基础知识</h2><p>磁盘基础知识</p>
<p>1.寻址:m/s</p>
<p>2.带宽:G/M</p>
<p>内存</p>
<p>1.寻址:ns</p>
<p>2.带宽:很大</p>
<p>秒&gt;毫秒&gt;微秒&gt;纳秒</p>
<p>内存寻址比硬盘寻址快10万倍</p>
<p>IO buffer</p>
<p>成本问题,</p>
<p>磁盘有磁道和扇区,一扇区512byte,带来成本变大:索引</p>
<p>4K对齐,操作系统无论读多少都是最少4k从磁盘拿</p>
<p>随着文件变大,速度变慢,IO成为瓶颈</p>
<p>数据库</p>
<p>data page 4k</p>
<p>关系型数据库建表:必须给出schema</p>
<p>类型:建表宽度</p>
<p>存:倾向于行级存储</p>
<p>内存维护一个b+树</p>
<p>磁盘:存储数据和索引</p>
<p>表很大的时候,性能下降?</p>
<ul>
<li>如果有索引,增删改变慢</li>
<li><p>查询速度</p>
<p>1.如果一个或少量查询,性能依然快,因为where条件走的依然是一个data page</p>
<p>2.当并发量来了,可能不是加载一个data page到内存,受硬盘带宽影响,有可能性能下降(IOPS)</p>
</li>
</ul>
<h2 id="折中做法"><a href="#折中做法" class="headerlink" title="折中做法"></a>折中做法</h2><p>将内存中的一部分数据做缓存</p>
<p><strong>memcached</strong></p>
<p>key value结构,value没有类型的概念</p>
<p><strong>redis(秒级十万操作)</strong></p>
<p>同为key value结构,value有类型,string(字符,数值,bitmaps),hashes,lists,sets,sorted sets</p>
<h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><p>make:在linux中属于编译命令,跟随文件makefile,但是这个命令需要config执行之后才会生成</p>
<pre><code>vim /etc/profile
#添加REDIS_HOME和PATH
source /etc/profile

cd $REDIS_HOME
make
#注意,需要提前安装g++,如果没装g++安装过程会报错,安装g++后记得make clean
cd utils
sh install_server.sh
#期间需要自行指定一些参数,记得改,尽量不要用默认的var
#这之后redis就可以作为服务进行启动了,执行文件为redis_端口号
</code></pre><h2 id="处理流程"><a href="#处理流程" class="headerlink" title="处理流程"></a>处理流程</h2><p>linux系统中存在kernel(内核),eppoll是一种系统调用,redis是单进程单线程单实例并发很多的请求,如何变得很快的呢?</p>
<p><strong>eppoll概念</strong></p>
<p>文件描述符从block(阻塞的)发展到noblock(非阻塞的),这时为同步非阻塞时期</p>
<p>此时发展出一个问题,用户进程轮询调用1000次kernel,成本问题</p>
<p>这时发展出了<strong>select概念</strong></p>
<p>统一把这一千个文件描述符传给select,多路复用nio,减少了内核态和用户态的切换</p>
<p>这些所有的功能都是由jvm实现的,jvm由c编写</p>
<h2 id="关于linux用户态和内核态"><a href="#关于linux用户态和内核态" class="headerlink" title="关于linux用户态和内核态"></a>关于linux用户态和内核态</h2><p>问题:文件描述符相关数据拷来拷去成为累赘</p>
<p>内核有内核的空间,用户有用户的空间,所以伸展出一个内核和用户的共享空间</p>
<p>共享空间由红黑树+链表+mmap实现</p>
<pre><code>man epoll
</code></pre><p>epoll - I/O event notification facility(I/O事件通知功能)<br>epoll  is  a  variant  of poll(2) that can be used either as an edge-triggered or a level-triggered interface and scales well to large numbers of watched file descriptors.  The following system calls are provided to create and manage an epoll instance:<br>(epoll是poll(2)的一个变体，它既可以用作边缘触发接口，也可以用作级别触发接口，并且可以很好地扩展到大量被监视的文件描述符。提供以下系统调用来创建和管理epoll实例:)</p>
<ul>
<li>An epoll instance created by epoll_create(2), which returns a file descriptor referring to the epoll instance. (The more recent epoll_create1(2) extends the functionality of epoll_create(2).)<br>(由epoll_create(2)创建的epoll实例，它返回引用epoll实例的文件描述符。(最近的epoll_create1(2)扩展了<br>epoll_create(2)的功能。)</li>
<li>Interest  in  particular  file  descriptors  is then registered via epoll_ctl(2).  The set of file descriptors currently registered on an epoll instance is sometimes called an epoll set.<br>(然后通过epoll_ctl(2)注册特定文件描述符。当前注册在epoll实例上的文件描述符集有时称为epoll集。)</li>
<li>Finally, the actual wait is started by epoll_wait(2).<br>(最后，实际的等待由epoll_wait(2)启动。)</li>
</ul>
<pre><code>man 2 sendfile
</code></pre><ul>
<li>sendfile()  copies  data  between  one  file  descriptor and another.  Because this copying is done within the kernel, sendfile() is more efficient than the combination of read(2) and write(2), which would require transferring data to and from user space.<br>sendfile()在一个文件描述符和另一个文件描述符之间复制数据。因为这种复制是在内核中完成的，所以sendfile()比read(2)和write(2)的组合更有效，后者需要在用户空间和用户空间之间传输数据.</li>
<li>in_fd should be a file descriptor opened for reading and out_fd should be a descriptor opened for writing.<br>in_fd应该是一个打开用于读取的文件描述符，out_fd应该是一个打开用于写入的描述符。</li>
<li>If offset is not NULL, then it points to a variable holding the file offset from which sendfile() will start reading data from in_fd.  When sendfile() returns, this variable will be set to  the  offset  of the byte following the last byte that was read.  If offset is not NULL, then sendfile() does not modify the current file offset of in_fd; otherwise the current file offset is adjusted to reflect the number of bytes read from in_fd.<br>如果偏移量不为空，那么它指向一个保存文件偏移量的变量，sendfile()将从该变量开始从in_fd读取数据。当sendfile()返回时，该变量将被设置为读取的最后一个字节之后的字节的偏移量。如果偏移量不为空，则sendfile()不修改in_fd的当前文件偏移量;否则，将调整当前文件偏移量，以反映从in_fd读取的字节数。</li>
<li>count is the number of bytes to copy between the file descriptors.<br>count是要在文件描述符之间复制的字节数。</li>
<li>Presently (Linux 2.6.9): in_fd, must correspond to a file which supports mmap(2)-like operations (i.e., it cannot be a socket); and out_fd must refer to a socket.<br>当前(Linux 2.6.9): in_fd，必须对应于支持mmap(2)类操作的文件(即，不能是socket);out_fd必须引用socket。</li>
<li>Applications may wish to fall back to read(2)/write(2) in the case where sendfile() fails with EINVAL or ENOSYS.<br>当sendfile()在EINVAL或ENOSYS中失败时，应用程序可能希望返回到read(2)/write(2)。</li>
</ul>
<h2 id="实际操作"><a href="#实际操作" class="headerlink" title="实际操作"></a>实际操作</h2><h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><pre><code>redis-cli help
</code></pre><p>redis默认共有16个库,可以在配置文件中修改</p>
<pre><code>set k380 hello
get k380
help @generic
keys *

#清库,慎用,my friend
flushdb
flushall

help@string

#不存在的时候才去设置,一旦有设置,则新的设置无效(只能新建)
set k1 ooxx nx

#存在的时候才去设置,一旦没有设置,则新的设置无效(只能更新)
set k2 hello xx

#批量
mset k3 a k4 b
mget k3 k4

append k1 world
#正反向索引
getrange k1 5 -1
setrange k1 5 &quot; xiaowu&quot;

strlen k1

#查看k1的value类型
type k1

set k2 99
type k2

object help

#面向字符串可以有计算类型,这里的int指的是k2的value的编码类型而不是type
object encoding k2
#加减
incrby k2 12
decr k2
decrby k2 22
incrbyfloat k2 0.5

#2中类型,embstr,row
set k3 jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj
object encoding k3
append k3 jjjjjjj
object encoding k3

flushall

#二进制安全演示
set k1 hello
strlen k1
set k2 9
object encoding k2
strlen k2
append k2 999
get k2
object encoding k2
incr k2
object encoding k2
strlen k2

#utf-8和gbk编码
set k3 a
get k3
strlen k3
append k3 中
get k3
strlen k3

#触发格式化操作,&quot;中&quot;字可以正常显示
redis-cli --raw

#原子性操作
msetnx k1 a k2 b
mget k1 k2
msetnx k2 c k3 d
mget k1 k2 k3

flushall

#一个字节8位
help setbit
setbit k1 1 1
strlen k1
setbit k1 7 1
#01000001
setbit k1 9 1
strlen k1
get k1

#就算是只找第二个字节,依然会返回全量字节的索引下标
help bitpos
bitpos k1 1 0 0
bitpos k1 1 1 1
bitpos k1 1 0 1

#统计次数
bitcount k1 1 0 1

flushall
#位操作,与或非
setbit k1 1 1
setbit k1 7 1
get k1
setbit k2 1 1
setbit k2 6 1
#与操作 有0则0,全1为1
#01000000
bittop and andkey k1 k2

#或操作 有1则1,全0为0
#01000011
bittop or orkey k1 k2
</code></pre><h3 id="list"><a href="#list" class="headerlink" title="list"></a>list</h3><pre><code>help @list

#向k1中添加
lpush k1 a b c d e f
#l代表左边,插入的结构实际为f e d c b a

rpush k2 a b c d e f
#r代表右边,插入的结构实际为a b c d e f

#弹出元素
lpop k1
#这个东西与栈类似

#弹出元素
rpop k1
#栈:同向命令
#队列:反向命令

#查看
lrange k1 0 -1

#根据下标取
lindex k1 2
lindex k1 -1

#根据下标设置
lset k1 3 xxxx

#删除
lrem k3 2 a
#2为正数代表正向删除,为负数代表反向删除

linsert k3 after 6 a
#在元素6之后插入,而不是下标了
#如果有两个相同元素,会在第一个元素6之后插入,而不是两个6全插入

linsert k3 before 3 a

#反向删除
lrem k3 -2 a

#统计数量
llen k3

#开三个客户端测试阻塞
blpop ooxx 0
#两个客户端阻塞,一个客户端新增数据,有机会测一下

#两端删除
ltrim k4 0 -1
ltrim k4 2 -2
#从下标2开始到下标-2留下,也就是说下标0,1,-1删除
</code></pre><h3 id="hashmap"><a href="#hashmap" class="headerlink" title="hashmap"></a>hashmap</h3><pre><code>set sean::name &#39;minato aqua&#39;
get sean::name 
set sean::age 18
get sean::age
keys sean*

hset sean name &#39;minato aqua&#39;
hmset sean age 18 address hovelive

hget sean name
hget sean address
hmget sean name age
hkeys sean
hvals sean
hgetall sean

hincrbyfloat sean age 0.5
hincrbyfloat sean age -1
#hashmap应用场景:收藏,详情页,点赞,修改数据等等
</code></pre><h3 id="set"><a href="#set" class="headerlink" title="set"></a>set</h3><pre><code>#set特点:无序+去重
help @set
sadd k1 tom sean peter ooxx tom xxoo
smembers k1
srem k1 xxoo ooxx
smembers k1

sadd k2 1 2 3 4 5
sadd k3 4 5 6 7 8

sinter k2 k3

#插入到dest里头
sinterstore dest k2 k3

sunion k2 k3
#同上,存在rstore,并集

sdiff k2 k3
sdiff k3 k2
#外差集,两个结果并不一样,右侧为参考基准

srandmember k1 5 -5 10 -10
#为正数的时候,取出一个去重的结果集(不能超过已有结果集)
#为负数的时候,取出一个带重复的结果集(一定会满足你要的数量)
#为0,不返回结果

spop k1
</code></pre><h3 id="sorted-set"><a href="#sorted-set" class="headerlink" title="sorted set"></a>sorted set</h3><pre><code>#想让它们怎么排序?名称?大小?价格?
help @sorted_set

zadd k1 8 apple 2 banana 3 orange
#物理内存左小右大,不随命令发生变化

#查看
zrange k1 0 -1

#查看分值
zrange k1 0 -1 withscores

#取分值范围
zrangebyscore k1 3 8

#正向取
zrange k1 0 1

#反向取
zrevrange k1 0 1

#通过值取分值
zscore k1 apple

#取出排名
zrank k1 apple

#查看所有
zrange k1 0 -1 withscores

#增加
zinsrby k1 2.5 banana

#实时根据修改更新排序
zrange k1 0 -1 withscores

#集合取并集
zadd k1 80 tom 60 sean 70 baby
zadd k2 60 tom 100 sean 40 yiming
zunionstore unkey 2 k1 k2
zrange unkey 0 -1 withscores

#设置权重
zunionstore unkey1 2 k1 k2 weights 1 0.5
#k1里面的不变,k2里面的乘0.5
zrange unkey1 0 -1 withscores

#取最大的
zunionstore unkey2 2 k1 k2 aggregate max
zrange unkey2 0 -1 withscores
</code></pre><p>排序是怎么实现的怎删改查的速度?</p>
<p>引申出知识点:跳跃表(skip list),平衡树</p>
<p><img src="https://www.yremp.live/images/2019/09/03/201609062227331486b065.jpg" alt="跳跃表"></p>
<h2 id="缓存和数据库"><a href="#缓存和数据库" class="headerlink" title="缓存和数据库"></a>缓存和数据库</h2><h3 id="管道技术"><a href="#管道技术" class="headerlink" title="管道技术"></a>管道技术</h3><p>一个请求/相应服务可以实现为，即使客户端没有读取到旧请求的响应，服务端依旧可以处理新请求。通过这种方式，可以完全无需等待服务端应答地发送多条指令给服务端，并最终一次性读取所有应答。管道技术最显著的优势是提高了redis服务的性能。</p>
<pre><code>yum install nc
nc localhost 6379
keys *
echo -e &quot;set k2 99\nincr k2\n get k2&quot; | nc localhost 6379
</code></pre><h3 id="Pub-Sub"><a href="#Pub-Sub" class="headerlink" title="Pub/Sub"></a>Pub/Sub</h3><p>订阅，取消订阅和发布实现了发布/订阅消息范式(引自wikipedia)，发送者（发布者）不是计划发送消息给特定的接收者（订阅者）。而是发布的消息分到不同的频道，不需要知道什么样的订阅者订阅。订阅者对一个或多个频道感兴趣，只需接收感兴趣的消息，不需要知道什么样的发布者发布的。这种发布者和订阅者的解耦合可以带来更大的扩展性和更加动态的网络拓扑。</p>
<p>Redis可以执行发布/订阅模式(publish/subscribe), 该模式可以解耦消息的发送者和接收者,使程序具有更好的扩展性.从宏观上来讲,Redis的发布/订阅模式具有如下特点:</p>
<ul>
<li>客户端执行订阅以后,除了可以继续订阅(SUBSCRIBE或者PSUBSCRIBE),取消订阅(UNSUBSCRIBE或者PUNSUBSCRIBE), PING命令和结束连接(QUIT)外, 不能执行其他操作,客户端将阻塞直到订阅通道上发布消息的到来.</li>
<li>发布的消息在Redis系统中不存储.因此,必须先执行订阅,再等待消息发布. 但是,相反的顺序则不支持.</li>
<li>订阅的通道名称支持glob模式匹配.如果客户端同时订阅了glob模式的通道和非glob模式的通道,并且名称存在交集,则对于一个发布的消息,该执行订阅的客户端接收到两个消息.</li>
</ul>
<p><strong>pub/sub API</strong><br>Redis的发布/订阅设计模式相关的命令有六个:</p>
<ul>
<li>SUBSCRIBE命令执行订阅.客户端可以多次执行该命令, 也可以一次订阅多个通道. 多个客户端可以订阅相同的通道.该命令的响应包括三部分, 依次是:命令名称(字符串subscribe),订阅的通道名称,总共订阅的通道数(包含glob通道).</li>
<li>PSUBSCRIBE命令执行glob模式订阅.客户端可以多次执行该命令, 也可以一次订阅多个glob通道. 多个客户端可以订阅相同的glob通道.该命令的响应包括三部分, 依次是:命令名称(字符串psubscribe),订阅的glob通道名称,总共订阅的通道数(包含非glob通道).</li>
<li>UNSUBSCRIBE命令取消订阅指定的通道.可以指定一个或者多个取消的订阅通道名称,也可以不带任何参数,此时将取消所有的订阅的通道(不包括glob通道).该命令的响应包括三部分, 依次是:命令名称(字符串unsubscribe),取消的订阅通道名称,总共订阅的通道数(包含glob通道).</li>
<li>PUNSUBSCRIBE命令取消订阅指定的glob模式通道.可以指定一个或者多个取消的glob模式的订阅通道名称,也可以不带任何参数,此时将取消所有的glob模式订阅的通道(不包括非glob通道).该命令的响应包括三部分, 依次是:命令名称(字符串punsubscribe),取消的glob模式的订阅通道名称,总共订阅的通道数(包含非glob通道).</li>
<li>PUBLISH命令在指定的通道上发布消息.只能在一个通道上发布消息,不能在多个通道上同时发布消息.该命令的响应包括通知的接收者个数,需要注意的是,这里的接收者数目大于等于订阅该通道的客户端数目(因为一个客户端的glob通道和非glob通道同时匹配发布通道的话,则视为两个接收者).而在接收端,收到的响应包括三部分,依次是 :message或者pmessage字符串(取决于是否为glob匹配),匹配的通道名称,发布的消息内容.</li>
<li>PUBSUB命令执行状态查询.支持若干子命令.需要注意的是,该命令不能在客户端进入订阅后执行.</li>
</ul>
<pre><code>#消息通道(广播)
help @pubsub

#客户端执行
SUBSCRIBE aqua
#服务端执行
PUBLISH aqua &quot;i&#39;m minato aqua&quot;

#消费端链接以后才能正常接收消息,未连接客户端之前的消息不会被接收到
publish aqua hello

#列出当前的活跃频道
PUBSUB channels

#返回给定频道的订阅者数量,订阅模式的客户端不计算在内
PUBSUB numsub aqua mea

#返回订阅模式的数量
client1:PSUBSCRIBE aqua mea
client2:PSUBSCRIBE mea aqua
client3:pubsub numpat
</code></pre><p>小结:</p>
<ul>
<li>只有在订阅客户端上,才能取消订阅. 一个客户端连接不能为另一个客户端连接取消订阅. 这是显而易见的.</li>
<li>在发布/订阅模式下,通道名称是全局的,和客户端连接的Redis数据库没有关系.</li>
</ul>
<h3 id="缓存的数据-热数据"><a href="#缓存的数据-热数据" class="headerlink" title="缓存的数据(热数据)"></a>缓存的数据(热数据)</h3><p>如何随着业务进行变化?</p>
<p>引出知识点:</p>
<p>key的有效期</p>
<p>设置key的过期时间，超过时间后，将会自动删除该key。在Redis的术语中一个key的相关超时是不确定的</p>
<p>超时后只有对key执行<code>DEL命令</code>或者<code>SET命令</code>或者<code>GETSET时</code>才会清除。这意味着，从概念上讲所有改变key的值的操作都会使他清除。 例如，<code>INCR</code>递增key的值，执行<code>LPUSH</code>操作，或者用<code>HSET</code>改变hash的<code>field</code>所有这些操作都会触发删除动作</p>
<p>使用<code>PERSIST</code>命令可以清除超时，使其变成一个永久的key</p>
<p>如果key被<code>RENAME</code>命令修改，相关的超时时间会转移到新key上面</p>
<p>如果key被<code>RENAME</code>命令修改，比如原来就存在Key_A,然后调用<code>RENAME Key_B Key_A</code>命令，这时不管原来Key_A是永久的还是设置为超时的，都会由Key_B的有效期状态覆盖</p>
<p>对已经有过期时间的key执行<code>EXPIRE</code>操作，将会更新它的过期时间。有很多应用有这种业务场景，例如记录会话的session</p>
<p><strong>返回值</strong></p>
<p>integer-reply, 具体的:</p>
<ul>
<li><code>1</code> 如果成功设置过期时间。</li>
<li><code>0</code> 如果key不存在或者不能设置过期时间。</li>
</ul>
<pre><code>set aqua minatoaqua
get aqua
expire aqua 10
ttl aqua
ttl aqua
set aqua &quot;i&#39;m minato aqua&quot;
ttl aqua
</code></pre><h3 id="Keys的过期时间"><a href="#Keys的过期时间" class="headerlink" title="Keys的过期时间"></a>Keys的过期时间</h3><p>通常Redis keys创建时没有设置相关过期时间。他们会一直存在，除非使用显示的命令移除，例如，使用<a href="http://www.redis.cn/commands/del.html" target="_blank" rel="noopener">DEL</a>命令</p>
<p><code>EXPIRE</code>一类命令能关联到一个有额外内存开销的key。当key执行过期操作时，Redis会确保按照规定时间删除他们</p>
<p>key的过期时间和永久有效性可以通过<code>EXPIRE</code>和<a href="http://www.redis.cn/commands/persist.html" target="_blank" rel="noopener">PERSIST</a>命令（或者其他相关命令）来进行更新或者删除过期时间</p>
<h3 id="过期精度"><a href="#过期精度" class="headerlink" title="过期精度"></a>过期精度</h3><p>在 Redis 2.4 及以前版本，过期期时间可能不是十分准确，有0-1秒的误差</p>
<p>从 Redis 2.6 起，过期时间误差缩小到0-1毫秒</p>
<h3 id="过期和持久"><a href="#过期和持久" class="headerlink" title="过期和持久"></a>过期和持久</h3><p>Keys的过期时间使用Unix时间戳存储(从Redis 2.6开始以毫秒为单位)。这意味着即使Redis实例不可用，时间也是一直在流逝的</p>
<p>要想过期的工作处理好，计算机必须采用稳定的时间。 如果你将RDB文件在两台时钟不同步的电脑间同步，有趣的事会发生(所有的 keys装载时就会过期)</p>
<p>即使正在运行的实例也会检查计算机的时钟，例如如果你设置了一个key的有效期是1000秒，然后设置你的计算机时间为未来2000秒，这时key会立即失效，而不是等1000秒之后</p>
<h3 id="如何淘汰过期的keys"><a href="#如何淘汰过期的keys" class="headerlink" title="如何淘汰过期的keys"></a>如何淘汰过期的keys</h3><p>Redis keys过期有两种方式：被动和主动方式</p>
<p>当一些客户端尝试访问它时，key会被发现并主动的过期</p>
<p>当然，这样是不够的，因为有些过期的keys，永远不会访问他们。 无论如何，这些keys应该过期，所以定时随机测试设置keys的过期时间。所有这些过期的keys将会从密钥空间删除</p>
<p>具体就是Redis每秒10次做的事情：</p>
<ol>
<li>测试随机的20个keys进行相关过期检测。</li>
<li>删除所有已经过期的keys。</li>
<li>如果有多于25%的keys过期，重复步奏1.</li>
</ol>
<p>这是一个平凡的概率算法，基本上的假设是，我们的样本是这个密钥控件，并且我们不断重复过期检测，直到过期的keys的百分百低于25%,这意味着，在任何给定的时刻，最多会清除1/4的过期keys</p>
<h3 id="在复制AOF文件时如何处理过期"><a href="#在复制AOF文件时如何处理过期" class="headerlink" title="在复制AOF文件时如何处理过期"></a>在复制AOF文件时如何处理过期</h3><p>为了获得正确的行为而不牺牲一致性，当一个key过期，<code>DEL</code>将会随着AOF文字一起合成到所有附加的slaves。在master实例中，这种方法是集中的，并且不存在一致性错误的机会</p>
<p>然而，当slaves连接到master时，不会独立过期keys（会等到master执行DEL命令），他们任然会在数据集里面存在，所以当slave当选为master时淘汰keys会独立执行，然后成为master</p>
<h2 id="事物"><a href="#事物" class="headerlink" title="事物"></a>事物</h2><p>redis是单进程的,所以事物回滚存在一些与关系型数据库的差别</p>
<p>multi,exec,discard,watch(乐观锁的效果)</p>
<p><a href="http://www.redis.cn/commands/multi.html" target="_blank" rel="noopener">MULTI</a> 、 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 、 <a href="http://www.redis.cn/commands/discard.html" target="_blank" rel="noopener">DISCARD</a> 和 <a href="http://www.redis.cn/commands/watch.html" target="_blank" rel="noopener">WATCH</a> 是 Redis 事务相关的命令。事务可以一次执行多个命令， 并且带有以下两个重要的保证：</p>
<ul>
<li>事务是一个单独的隔离操作：事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。</li>
<li>事务是一个原子操作：事务中的命令要么全部被执行，要么全部都不执行。</li>
</ul>
<p><a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 命令负责触发并执行事务中的所有命令：</p>
<ul>
<li>如果客户端在使用 <a href="http://www.redis.cn/commands/multi.html" target="_blank" rel="noopener">MULTI</a> 开启了一个事务之后，却因为断线而没有成功执行 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> ，那么事务中的所有命令都不会被执行。</li>
<li>另一方面，如果客户端成功在开启事务之后执行 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> ，那么事务中的所有命令都会被执行。</li>
</ul>
<p>当使用 AOF 方式做持久化的时候， Redis 会使用单个 write(2) 命令将事务写入到磁盘中。</p>
<p>然而，如果 Redis 服务器因为某些原因被管理员杀死，或者遇上某种硬件故障，那么可能只有部分事务命令会被成功写入到磁盘中。</p>
<p>如果 Redis 在重新启动时发现 AOF 文件出了这样的问题，那么它会退出，并汇报一个错误。</p>
<p>使用<code>redis-check-aof</code>程序可以修复这一问题：它会移除 AOF 文件中不完整事务的信息，确保服务器可以顺利启动。</p>
<p>从 2.2 版本开始，Redis 还可以通过乐观锁（optimistic lock）实现 CAS （check-and-set）操作，具体信息请参考文档的后半部分。</p>
<h4 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h4><p><a href="http://www.redis.cn/commands/multi.html" target="_blank" rel="noopener">MULTI</a> 命令用于开启一个事务，它总是返回 <code>OK</code> 。 <a href="http://www.redis.cn/commands/multi.html" target="_blank" rel="noopener">MULTI</a> 执行之后， 客户端可以继续向服务器发送任意多条命令， 这些命令不会立即被执行， 而是被放到一个队列中， 当 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a>命令被调用时， 所有队列中的命令才会被执行。</p>
<p>另一方面， 通过调用 <a href="http://www.redis.cn/commands/discard.html" target="_blank" rel="noopener">DISCARD</a> ， 客户端可以清空事务队列， 并放弃执行事务。</p>
<pre><code>multi
incr aqua
incr mea
exec
keys *
</code></pre><p><a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 命令的回复是一个数组， 数组中的每个元素都是执行事务中的命令所产生的回复。 其中， 回复元素的先后顺序和命令发送的先后顺序一致。</p>
<p>当客户端处于事务状态时， 所有传入的命令都会返回一个内容为 <code>QUEUED</code> 的状态回复（status reply）， 这些被入队的命令将在 EXEC 命令被调用时执行。</p>
<h4 id="事务中的错误"><a href="#事务中的错误" class="headerlink" title="事务中的错误"></a>事务中的错误</h4><p>使用事务时可能会遇上以下两种错误：</p>
<ul>
<li>事务在执行 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 之前，入队的命令可能会出错。比如说，命令可能会产生语法错误（参数数量错误，参数名错误，等等），或者其他更严重的错误，比如内存不足（如果服务器使用 <code>maxmemory</code> 设置了最大内存限制的话）。</li>
<li>命令可能在 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 调用之后失败。举个例子，事务中的命令可能处理了错误类型的键，比如将列表命令用在了字符串键上面，诸如此类。</li>
</ul>
<p>对于发生在 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 执行之前的错误，客户端以前的做法是检查命令入队所得的返回值：如果命令入队时返回 <code>QUEUED</code> ，那么入队成功；否则，就是入队失败。如果有命令在入队时失败，那么大部分客户端都会停止并取消这个事务。</p>
<p>不过，从 Redis 2.6.5 开始，服务器会对命令入队失败的情况进行记录，并在客户端调用 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 命令时，拒绝执行并自动放弃这个事务。</p>
<p>在 Redis 2.6.5 以前， Redis 只执行事务中那些入队成功的命令，而忽略那些入队失败的命令。 而新的处理方式则使得在流水线（pipeline）中包含事务变得简单，因为发送事务和读取事务的回复都只需要和服务器进行一次通讯。</p>
<p>至于那些在 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 命令执行之后所产生的错误， 并没有对它们进行特别处理： 即使事务中有某个/某些命令在执行时产生了错误， 事务中的其他命令仍然会继续执行。</p>
<p>从协议的角度来看这个问题，会更容易理解一些。 以下例子中， <a href="http://www.redis.cn/commands/lpop.html" target="_blank" rel="noopener">LPOP</a> 命令的执行将出错， 尽管调用它的语法是正确的：</p>
<pre><code>multi
set aqua minatoaqua
lpop aqua
exec
</code></pre><p><a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 返回两条<a href="http://www.redis.cn/topics/protocol.html#bulk-string-reply" target="_blank" rel="noopener">bulk-string-reply</a>： 第一条是 <code>OK</code> ，而第二条是 <code>-ERR</code> 。 至于怎样用合适的方法来表示事务中的错误， 则是由客户端自己决定的。</p>
<p>最重要的是记住这样一条， 即使事务中有某条/某些命令执行失败了， 事务队列中的其他命令仍然会继续执行 —— Redis 不会停止执行事务中的命令。</p>
<p>以下例子展示的是另一种情况， 当命令在入队时产生错误， 错误会立即被返回给客户端：</p>
<pre><code>multi
incr a b c
</code></pre><p>因为调用 <a href="http://www.redis.cn/commands/incr.html" target="_blank" rel="noopener">INCR</a> 命令的参数格式不正确， 所以这个 <a href="http://www.redis.cn/commands/incr.html" target="_blank" rel="noopener">INCR</a> 命令入队失败。</p>
<h4 id="为什么-Redis-不支持回滚（roll-back）"><a href="#为什么-Redis-不支持回滚（roll-back）" class="headerlink" title="为什么 Redis 不支持回滚（roll back）"></a>为什么 Redis 不支持回滚（roll back）</h4><p>如果你有使用关系式数据库的经验， 那么 “Redis 在事务失败时不进行回滚，而是继续执行余下的命令”这种做法可能会让你觉得有点奇怪。</p>
<p>以下是这种做法的优点：</p>
<ul>
<li>Redis 命令只会因为错误的语法而失败（并且这些问题不能在入队时发现），或是命令用在了错误类型的键上面：这也就是说，从实用性的角度来说，失败的命令是由编程错误造成的，而这些错误应该在开发的过程中被发现，而不应该出现在生产环境中。</li>
<li>因为不需要对回滚进行支持，所以 Redis 的内部可以保持简单且快速。</li>
</ul>
<p>有种观点认为 Redis 处理事务的做法会产生 bug ， 然而需要注意的是， 在通常情况下， 回滚并不能解决编程错误带来的问题。 举个例子， 如果你本来想通过 <a href="http://www.redis.cn/commands/incr.html" target="_blank" rel="noopener">INCR</a> 命令将键的值加上 1 ， 却不小心加上了 2 ， 又或者对错误类型的键执行了 <a href="http://www.redis.cn/commands/incr.html" target="_blank" rel="noopener">INCR</a>， 回滚是没有办法处理这些情况的。</p>
<h4 id="放弃事务"><a href="#放弃事务" class="headerlink" title="放弃事务"></a>放弃事务</h4><p>当执行 <a href="http://www.redis.cn/commands/discard.html" target="_blank" rel="noopener">DISCARD</a> 命令时， 事务会被放弃， 事务队列会被清空， 并且客户端会从事务状态中退出：</p>
<pre><code>set aqua minatoaqua
multi
incr aqua
discard
get aqua
</code></pre><h4 id="使用-check-and-set-操作实现乐观锁"><a href="#使用-check-and-set-操作实现乐观锁" class="headerlink" title="使用 check-and-set 操作实现乐观锁"></a>使用 check-and-set 操作实现乐观锁</h4><p><a href="http://www.redis.cn/commands/watch.html" target="_blank" rel="noopener">WATCH</a> 命令可以为 Redis 事务提供 check-and-set （CAS）行为。</p>
<p>被 <a href="http://www.redis.cn/commands/watch.html" target="_blank" rel="noopener">WATCH</a> 的键会被监视，并会发觉这些键是否被改动过了。 如果有至少一个被监视的键在 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 执行之前被修改了， 那么整个事务都会被取消， <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 返回<a href="http://www.redis.cn/topics/protocol.html#nil-reply" target="_blank" rel="noopener">nil-reply</a>来表示事务已经失败。</p>
<p>举个例子， 假设我们需要原子性地为某个值进行增 1 操作（假设 <a href="http://www.redis.cn/commands/incr.html" target="_blank" rel="noopener">INCR</a> 不存在）。</p>
<p>首先我们可能会这样做：</p>
<pre><code>set aqua 17
mea = get aqua
mea = val + 1
set aqua $mea
</code></pre><p>上面的这个实现在只有一个客户端的时候可以执行得很好。 但是， 当多个客户端同时对同一个键进行这样的操作时， 就会产生竞争条件。举个例子， 如果客户端 A 和 B 都读取了键原来的值， 比如 10 ， 那么两个客户端都会将键的值设为 11 ， 但正确的结果应该是 12 才对。</p>
<p>有了 <a href="http://www.redis.cn/commands/watch.html" target="_blank" rel="noopener">WATCH</a> ， 我们就可以轻松地解决这类问题了：</p>
<pre><code>watch aqua
mea = get aqua
mea = mea + 1
multi
set aqua $mea
exec
</code></pre><p>使用上面的代码， 如果在 <a href="http://www.redis.cn/commands/watch.html" target="_blank" rel="noopener">WATCH</a> 执行之后， <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 执行之前， 有其他客户端修改了 <code>mykey</code> 的值， 那么当前客户端的事务就会失败。 程序需要做的， 就是不断重试这个操作， 直到没有发生碰撞为止。</p>
<p>这种形式的锁被称作乐观锁， 它是一种非常强大的锁机制。 并且因为大多数情况下， 不同的客户端会访问不同的键， 碰撞的情况一般都很少， 所以通常并不需要进行重试。</p>
<h4 id="WATCH"><a href="#WATCH" class="headerlink" title="WATCH"></a>WATCH</h4><p><a href="http://www.redis.cn/commands/watch.html" target="_blank" rel="noopener">WATCH</a> 使得 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 命令需要有条件地执行： 事务只能在所有被监视键都没有被修改的前提下执行， 如果这个前提不能满足的话，事务就不会被执行。</p>
<pre><code>client1:
set aqua 17
watch aqua
MULTI
get aqua
set aqua 18
client2:
set aqua 14
client1:
exec
#可以发现,事物并没有执行
</code></pre><p><a href="http://www.redis.cn/commands/watch.html" target="_blank" rel="noopener">WATCH</a> 命令可以被调用多次。 对键的监视从 <a href="http://www.redis.cn/commands/watch.html" target="_blank" rel="noopener">WATCH</a> 执行之后开始生效， 直到调用 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 为止。</p>
<p>用户还可以在单个 <a href="http://www.redis.cn/commands/watch.html" target="_blank" rel="noopener">WATCH</a> 命令中监视任意多个键， 就像这样：</p>
<pre><code>watch aqua mea cierra
</code></pre><p>当 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 被调用时， 不管事务是否成功执行， 对所有键的监视都会被取消。</p>
<p>另外， 当客户端断开连接时， 该客户端对键的监视也会被取消。</p>
<p>使用无参数的 <a href="http://www.redis.cn/commands/unwatch.html" target="_blank" rel="noopener">UNWATCH</a> 命令可以手动取消对所有键的监视。 对于一些需要改动多个键的事务， 有时候程序需要同时对多个键进行加锁， 然后检查这些键的当前值是否符合程序的要求。 当值达不到要求时， 就可以使用 <a href="http://www.redis.cn/commands/unwatch.html" target="_blank" rel="noopener">UNWATCH</a> 命令来取消目前对键的监视， 中途放弃这个事务， 并等待事务的下次尝试。</p>
<h4 id="使用-WATCH-实现-ZPOP"><a href="#使用-WATCH-实现-ZPOP" class="headerlink" title="使用 WATCH 实现 ZPOP"></a>使用 WATCH 实现 ZPOP</h4><p><a href="http://www.redis.cn/commands/watch.html" target="_blank" rel="noopener">WATCH</a> 可以用于创建 Redis 没有内置的原子操作。举个例子， 以下代码实现了原创的 <a href="http://www.redis.cn/commands/zpop.html" target="_blank" rel="noopener">ZPOP</a> 命令， 它可以原子地弹出有序集合中分值（score）最小的元素：</p>
<pre><code>WATCH zset
element = ZRANGE zset 0 0
MULTI
ZREM zset element
EXEC
</code></pre><p>程序只要重复执行这段代码， 直到 <a href="http://www.redis.cn/commands/exec.html" target="_blank" rel="noopener">EXEC</a> 的返回值不是<a href="http://www.redis.cn/topics/protocol.html#nil-reply" target="_blank" rel="noopener">nil-reply</a>回复即可。</p>
<h4 id="Redis-脚本和事务"><a href="#Redis-脚本和事务" class="headerlink" title="Redis 脚本和事务"></a>Redis 脚本和事务</h4><p>从定义上来说， Redis 中的脚本本身就是一种事务， 所以任何在事务里可以完成的事， 在脚本里面也能完成。 并且一般来说， 使用脚本要来得更简单，并且速度更快。</p>
<p>因为脚本功能是 Redis 2.6 才引入的， 而事务功能则更早之前就存在了， 所以 Redis 才会同时存在两种处理事务的方法。</p>
<p>不过我们并不打算在短时间内就移除事务功能， 因为事务提供了一种即使不使用脚本， 也可以避免竞争条件的方法， 而且事务本身的实现并不复杂。</p>
<p>不过在不远的将来， 可能所有用户都会只使用脚本来实现事务也说不定。 如果真的发生这种情况的话， 那么我们将废弃并最终移除事务功能。</p>
<h3 id="布隆过滤器"><a href="#布隆过滤器" class="headerlink" title="布隆过滤器"></a>布隆过滤器</h3><h4 id="主要命令"><a href="#主要命令" class="headerlink" title="主要命令"></a>主要命令</h4><ul>
<li>bf.add 添加元素</li>
<li>bf.exists 查询元素是否存在</li>
<li>bf.madd 一次添加多个元素</li>
<li>bf.mexists 一次查询多个元素是否存在</li>
</ul>
<p>在 redis 中有两个值决定布隆过滤器的准确率：</p>
<ul>
<li>error_rate：允许布隆过滤器的错误率，这个值越低过滤器的位数组的大小越大，占用空间也就越大。</li>
<li>initial_size：布隆过滤器可以储存的元素个数，当实际存储的元素个数超过这个值之后，过滤器的准确率会下降。</li>
</ul>
<p>redis 中有一个命令可以来设置这两个值：</p>
<pre><code>bf.reserve test 0.01 100 
</code></pre><ul>
<li>第一个值是过滤器的名字。</li>
<li>第二个值为 error_rate 的值。</li>
<li>第三个值为 initial_size 的值。</li>
</ul>
<pre><code>redis-server --loadmodule /opt/yupsoftware/redis-5.0.5/redisbloom.so
bf.add hololive minatoaqua
bf.exists hololive minatoaqua
bf.exists hololive kaguramea
bf.madd hololive shirakamifubuki kaguramea nakiriayame ozorasubaru
bf.mexists hololive shirakamifubuki kaguramea nakiriayame ozorasubaru cierrarunis
bf.reserve test 0.001 10000
</code></pre><p>注意必须在add之前使用bf.reserve指令显式创建，如果对应的 key 已经存在，bf.reserve会报错。同时设置的错误率越低，需要的空间越大。如果不使用 bf.reserve，默认的error_rate是 0.01，默认的initial_size是 100。</p>
<h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><p>主要是解决大规模数据下不需要精确过滤的场景，如检查垃圾邮件地址，爬虫URL地址去重，解决缓存穿透问题等。</p>
<h3 id="布谷鸟过滤器"><a href="#布谷鸟过滤器" class="headerlink" title="布谷鸟过滤器"></a>布谷鸟过滤器</h3><p>实现了布隆过滤器的删除功能</p>

        </div>
        <!-- .entry-content -->
        </article></main></div>
        <div style="text-align:center; width: 100%" class="social-share share-mobile" data-disabled="diandian, tencent"></div>
        <footer class="post-footer">
          <div class="post-lincenses"><a href="javascript:;" target="_blank" rel="nofollow"><i class="fa fa-creative-commons" aria-hidden="true"></i> 知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a></div>
          <div class="post-tags">
          </div>
          <div class="post-share">
            <div class="social-share sharehidden share-component"></div>
            <i class="iconfont show-share icon-forward"></i>
          </div>
        </footer><!-- .entry-footer -->
      
      <!-- #post-## -->
      <div class="toc" style="background: none;"></div>
      <section class="post-squares nextprev">
        
          
            <div class="post-nepre half previous">
          
            <a href="/2019/09/03/多线程和高并发初识/" rel="prev">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/Secondes/cdn/img/loader/orange.progress-bar-stripe-loader.svg" data-src="https://www.yremp.live/images/2019/09/03/QQ201909031537213f4e5.jpg" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)">
              </div>
              <span class="label">
              Previous Post</span>
              <div class="info">
                <h3>
                多线程和高并发初识</h3>
                <hr>
              </div>
            </a>
          </div>
        
        
          
            <div class="post-nepre half next">
          
            <a href="/2019/08/25/关于流年大佬/" rel="next">
              <div class="background">
                <img class="lazyload" src="https://cdn.jsdelivr.net/gh/Secondes/cdn/img/loader/orange.progress-bar-stripe-loader.svg" data-src="https://www.yremp.live/images/2019/08/25/QQ20190825182010dd031.gif" style="width: 100%; height: 100%; object-fit: cover; pointer-events: none;" onerror="imgError(this,3)">
              </div>
              <span class="label">
              Next Post</span>
              <div class="info">
                <h3>
                关于流年大佬</h3>
                <hr>
              </div>
            </a>
          </div>
        
      </section>
      
<div id="vcomments"></div>
<script>
  window.onload = function(){
      var valine = new Valine();
      valine.init({
        el: '#vcomments',
        appId: "QXrHWOweL6iiH8ULUmPjBVhb-gzGzoHsz",
        appKey: "3es5KSduLLezurh1rn90e0vu",
        path: window.location.pathname,
        placeholder: "你是我一生只会遇见一次的惊喜 ..."
      })
  }
</script>

      
    <!-- #main -->
  </div><!-- #primary -->




    </div>    
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            // PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
        },
        ROOT_URL: '/',
        //CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
    <!-- <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 微笑<br>
      powered_by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer> -->
<footer id="colophon" class="site-footer" role="contentinfo">
  <div class="site-info">
    <div class="footertext">
      <div class="img-preload">
        <img src="https://cdn.jsdelivr.net/gh/secondes/cdn/img/other/wordpress-rotating-ball-o.svg">
        <img src="https://cdn.jsdelivr.net/gh/secondes/cdn/img/other/disqus-preloader.svg">
      </div>
      <p style="color: #666666;">&copy 2019</p>
    </div>
    <div class="footer-device">
    <p style="font-family: 'Ubuntu', sans-serif;">
        <span style="color: #b9b9b9;"> <i class="iconfont icon-sakura rotating" style="color: #ffc0cb;display:inline-block"></i>
		Thanks for theme Sakura by Mashiro&Hojun,Powered by Hexo,Hosted by Coding Pages
        </span>
      </p>
    </div>
  </div><!-- .site-info -->
</footer>



<!-- <script src="/js/tocbot.js"></script> -->
<script type="text/javascript" src="/js/lib.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script type="text/javascript" src="/js/InsightSearch.js"></script>
<script type="text/javascript" src="/js/jquery.fancybox.min.js"></script>
<script type="text/javascript" src="/js/zoom.min.js"></script>
<script type="text/javascript" src="/js/sakura-app.js"></script>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src="//unpkg.com/valine@1.3.4/dist/Valine.min.js"></script>
<!-- 不蒜子 网页计数器 -->
<script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script> -->
<script type="text/javascript">
/* <![CDATA[ */
if (/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  var Poi = {"pjax":"1","movies":{"url": "","name":"","live":"close"},"windowheight":"fixed","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
} else {
  var Poi = {"pjax":"1","movies":{"url": "","name":"","live":"open"},"windowheight":"auto","codelamp":"close","ajaxurl":"","order":"asc","formpostion":"bottom"};
}
/* ]]> */

</script>
<script>
$(document).ready(function() {
  if ($(".toc").length > 0 && document.body.clientWidth > 1200) {
    if ($(".pattern-center").length > 0) { //有图的情况
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -400,
          scrollSmoothOffset: -85
      });
    } else {
      tocbot.init({
          // Where to render the table of contents.
          tocSelector: '.toc', // 放置目录的容器
          // Where to grab the headings to build the table of contents.
          contentSelector: '.entry-content', // 正文内容所在
          // Which headings to grab inside of the contentSelector element.
          scrollSmooth: true,
          headingSelector: 'h1, h2, h3, h4, h5', // 需要索引的标题级别
          headingsOffset: -85,
          scrollSmoothOffset: -85
      });
    }
    var offsetTop = $('.toc').offset().top - 95;
    window.onscroll = function() {
      var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
      if (scrollTop >= offsetTop) {
        $('.toc').addClass('toc-fixed');
      } else {
        $('.toc').removeClass('toc-fixed');
      }
    }
  }
});
</script>

    <div class="openNav no-select" style="height: 50px;">
      <div class="iconflat no-select" style="width: 50px; height: 50px;">
        <div class="icon"></div>
      </div>
      <div class="site-branding search-form-submit">
        <i class="iconfont js-toggle-search iconsearch icon-search"></i>
      </div>
    </div>
  </section>
  <div id="mo-nav" class>
  <div class="m-avatar">
    <img src="https://q2.qlogo.cn/headimg_dl?dst_uin=46029882&spec=640">
  </div>
  <p style="text-align: center; color: #333; font-weight: 900; font-family: 'Ubuntu', sans-serif; letter-spacing: 1.5px">微笑の个人主页</p>
  <p style="text-align: center; word-spacing: 20px;">
    
      
        <a href="http://github.com/Secondes" class="fa fa-github" target="_blank" style="color: #333; margin-left:20px"></a>
      
        <a href="mqqwpa://im/chat?chat_type=wpa&uin=46029882&version=1&src_type=web&web_src=oicqzone.com" class="fa fa-qq" target="_blank" style="color: #25c6fe; margin-left:20px"></a>
      
    
  </p>
  <ul id="menu-new-1" class="menu">
    
      <li>
        <a href="/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-fort-awesome faa-shake" aria-hidden="true"></i>
            首页
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/archives">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-archive faa-shake" aria-hidden="true"></i>
            归档
          </span>
        </a>
        
          <ul class="sub-menu">
            
              <li>
                <a href="/categories/技术/">
                  <i class="fa fa-code" aria-hidden="true"></i>
                  技术
                </a>
              </li>
            
              <li>
                <a href="/categories/生活/">
                  <i class="fa fa-file-text-o" aria-hidden="true"></i>
                  生活
                </a>
              </li>
            
              <li>
                <a href="/categories/资源/">
                  <i class="fa fa-cloud-download" aria-hidden="true"></i>
                  资源
                </a>
              </li>
            
          </ul>
        
      </li>
    
      <li>
        <a href="/comment/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-pencil-square-o faa-tada" aria-hidden="true"></i>
            留言板
          </span>
        </a>
        
      </li>
    
      <li>
        <a href="/links/">
          <span class="faa-parent animated-hover">
            <i class="fa  fa-link faa-shake" aria-hidden="true"></i>
            友人帐
          </span>
        </a>
        
      </li>
    
  </ul>
  <p style="text-align: center; font-size: 13px; color: #b9b9b9;">&copy 2019 hexo-sakura</p>
</div>
<button onclick="topFunction()" class="mobile-cd-top" id="moblieGoTop" title="Go to top" style="display: none;"><i class="fa fa-chevron-up" aria-hidden="true"></i></button>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10/dist/APlayer.min.js"></script>
<style>
  .aplayer .aplayer-lrc {
    height: 35px;
  }
  .aplayer .aplayer-lrc p{
    font-size: 16px;
    font-weight: 700;
    line-height: 18px !important;
  }
  .aplayer .aplayer-lrc p.aplayer-lrc-current{
    color: #FF1493;
  }
  .aplayer.aplayer-narrow .aplayer-body{
    left: -66px !important;
  }
  .aplayer.aplayer-fixed .aplayer-lrc {
    display: none;
  }
  .aplayer .aplayer-lrc.aplayer-lrc-hide {
      display:none !important;
  }
  .aplayer.aplayer-fixed .lrc-show {
    display: block;
    background: rgba(255, 255, 255, 0.8);
  }
</style>
<div class="aplayer" data-id="2380067436" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="false" data-loop="all" data-order="random" data-preload="auto" data-volume="0.7" data-mutex="true" < div>
<script src="https://cdn.jsdelivr.net/npm/meting@1.2/dist/Meting.min.js"></script>
<script>
  $(function(){
    $('body').on('click', '.aplayer', function(){
      if($('.aplayer-button').hasClass('aplayer-play')) {
        $('.aplayer-lrc').removeClass('lrc-show');
      } else {
        $('.aplayer-lrc').addClass('lrc-show');
      }
    })
  });
</script></div>
  <script src="/js/snow.js"></script>
  <script type="text/javascript" src="/assets/autoload.js"></script>

  <div class="skin-menu no-select" id="mainskin" style="position: fixed">
    <div class="theme-controls row-container">
        <ul class="menu-list">
            <li id="white-bg"> <i class="fa fa-television" aria-hidden="true"></i></li>
            <li id="sakura-bg"> <i class="iconfont icon-sakura"></i></li>
            <li id="gribs-bg"> <i class="fa fa-slack" aria-hidden="true"></i></li>
            <li id="KAdots-bg"> <i class="iconfont icon-dots"></i></li>
            <li id="totem-bg"> <i class="fa fa-optin-monster" aria-hidden="true"></i></li>
            <li id="pixiv-bg"> <i class="iconfont icon-pixiv"></i></li>
            <li id="bing-bg"> <i class="iconfont icon-bing"></i></li>
            <li id="dark-bg"> <i class="fa fa-moon-o" aria-hidden="true"></i></li>
        </ul>
    </div>
	<canvas id="night-mode-cover"></canvas>
</div> 
  <-- <div class="changeSkin-gear no-select">
    <div class="keys" id="setbtn"> 
		<span id="open-skinMenu">切换主题<i class="iconfont icon-gear inline-block rotating"></i> 
		</span>
	</div>
</div> -->
  <div class="changeSkin-gear no-select">
    <div class="keys" id="setbtn"> 
		<span id="open-skinMenu">切换主题<i class="iconfont icon-gear inline-block rotating"></i> 
		</span>
	</div>
</div>
</body>
</html>